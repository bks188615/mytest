//获取配置信息
var Config;
var form;
var nowSelect;
var chartExcel; //echarts导出成Excel表需要
var baseZb = "num"; //area代表面积，num代表数量
var peace = ""; //全部为空，核心区，缓冲区，实验区
//保护区名称
var reserveName="";
var dmcolor=["#efb7d3","#c9fab8","#c4e3fb"];
var dmname=["核心区","缓冲区","实验区"];

var reserveLevel=false;
//切换全国督察区
var isSupervision=true;
//当前年份
var nowyear;
var tileInfo;
//人类活动边界颜色
var chinaZoneLayer="";//根据时间切换不同地图服务,矢量边界服务
var processLayer="";//根据时间切换不同地图服务,人类活动服务
var districtName = localStorage.getItem('province');
if(districtName !== "null" && districtName != null){
var  districtNameTZ = GetIframeQueryString('province');
var  plevelTZ =  GetIframeQueryString('plevel');
}
//获取从父页面iframe跳转地址的参数
function GetIframeQueryString(name) {
var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
if(!window.parent.document.getElementById("studyManageIframe") == false){
var r =window.parent.document.getElementById("studyManageIframe").contentWindow.location.search.substr(1).match(reg);
if (r != null) {
return decodeURI(r[2]);
}
return null;
}
}
var checkform;
var activeColor={
"采石场":"rgb(100,150,150)",	"工矿用地":"rgb(0,122,255)","能源设施":"rgb(200,180,0)","交通设施":"rgb(180,200,125)",
"旅游设施":"rgb(0,255,0)","养殖场":"rgb(0,255,197)","农业用地":"rgb(255,199,199)","居民点":"rgb(255,0,197)","其它人工设施":"rgb(255,0,0)"
}
//扩展String方法
String.prototype.replaceCharAt = function(n,c){
return this.substr(0, n)+ c + this.substr(n+1,this.length-1-n);
};
var configText = $.ajax({
async : false,
url : getRootPath() + '/config/serviceUrlConfig.json',
type : 'GET'
}).responseText;
Config = $.parseJSON(configText);

//获取下拉check值
function getCheckboxStr(name) {
var array = [];
$("input:checkbox[name='" + name + "']:checked").each(function() {
array.push($(this).val()); //向数组中添加元素
});
var str = array.join(',');
return str;
}
layui.use([ 'element', 'form', 'table', 'jquery', 'util', 'layer' ], function() {
var element = layui.element,
form = layui.form,
table = layui.table,
util = layui.util,
$ = layui.jquery;
checkform=form;
//
//获取年份信息并填充
$.ajax({
url: getRootPath() + 'gis/national/getNatureNameYear',
dataType: 'json',
type: 'post',
async: false,
success: function(data) {
var options = '';
data.result.forEach(function(item, index) {
var name;
//2017年之前整年一次，2017年之后每半年一次
if(item.YEAR<2017){
name=item.YEAR+"年";
}else{
name=item.YEAR.substr(0,4)+(item.YEAR.substr(4,6)=='01'?"上半年":"下半年");
}
$('#year').append('<option value='+ item.YEAR +'>'+ name +'</option>');
// 分屏列表
options += '<option value=' + item.YEAR + '>' + name + '</option>';

});
// 分屏列表
$('.map_year_select1').html(options);
$('.map_year_select2').html(options);
form.render();
//
chinaZoneLayer=Config["countryZone"+($("#year").val())];
processLayer=Config["process"+($("#year").val())];
nowyear=$('#year').val()
//lodeRightData($("#year").val(),'',0);
},
error: function(err) {
console.log(err);
}
});

//下拉checkbox
function checkListRender(name, width) {
var $this = $("." + name + "");
var $select = $this.next(".layui-form-select");
$select.addClass("downpanel");
var $dl = $select.find("dl");
$(".layui-select-title input", $select).val($this.attr("placeholder"));
$dl.empty();
var str = "";
$("option", $this).each(function() {
str = [ "<dd>", "<input type='checkbox' name='" + name + "'", $(this).val(), "' lay-skin='primary' title='", $(this).text(), "' value='" + $(this).val() + "'>", "</dd>" ].join("");
$dl.append(str);
});
form.render("checkbox");
//$select.find(".layui-form-checkbox").width(130);
$select.on("click", ".layui-select-title", function(e) {
var $select = $(this).parents(".layui-form-select");

nowSelect = $select
if ($select.hasClass("layui-form-selected")) {
$(".layui-form-select").not($select).removeClass("layui-form-selected");
$select.addClass("layui-form-selected");
//设置宽度
$(this).siblings("dl").find(".layui-form-checkbox").width(width);
} else {
$select.removeClass("layui-form-selected");
}
form.render("checkbox");
//赋值给input
$select.find("input[type='text']").val(getCheckboxStr(name)).attr("title", getCheckboxStr(name));

e.stopPropagation();
}).on("click", ".layui-form-checkbox", function(e) {
//当前选择的值
var val=$(this).find('span').text();

if(val=='全部'){
if($("input[name='"+name+"']").eq(0).prop("checked")){
$("input[name='"+name+"']").prop("checked", true);
}else{
$("input[name='"+name+"']").prop("checked", false);
}

}else{
$("input[name='"+name+"']").eq(0).prop("checked",false);
}

form.render("checkbox");
//赋值给input
nowSelect.find("input[type='text']").val(getCheckboxStr(name)).attr("title", getCheckboxStr(name));
e.stopPropagation();
});
}
//监听保护区名称输入框值改变
$('#zoneName').on('input propertychange',function(){
$.ajax({
url: getRootPath() + 'gis/human/activity/getNatureNames?year='+ $("#year").val()+'&search='+ $('#zoneName').val(),
dataType: 'json',
type: 'get',
success: function(data) {
$('.searchList').html('');
if(data.result.length > 0){
for(var i=0; i<data.result.length; i++){
$('.searchList').append('<li>'+data.result[i]+'</li>');
$('.searchList').show();
}
}

},
error: function(err) {
console.log(err);
}
});
});
$('.searchList').bind("click","li",function(e){
$('#zoneName').val($(e.target).text())
$('.searchList').hide();
})

//本底数据
form.on('switch(layerSwitch)', function (data) {
//添加当前年份本底服务
if(data.elem.checked){
App.leftMap.getLayer("countryZone"+$("#year").val()).setVisibility(true);
App.rightMap.getLayer("countryZone"+$("#year").val()).setVisibility(true);
}else{
App.leftMap.getLayer("countryZone"+$("#year").val()).setVisibility(false);
App.rightMap.getLayer("countryZone"+$("#year").val()).setVisibility(false);
}
});

App.init();
checkListRender("humanActive", 120);
checkListRender("zoneclass", 95);
checkListRender("baseType2", 110);


//折线图
$(".tabs .close").click(function(){
$(".details").hide();
});
$(".showDet").click(function(){
$(".details").show();
App.loadLineChar(App.level,App.districtName);
});

form.on('radio', function(data){

App.loadLineChar(App.level,App.districtName);
});

$(".tabs li").click(function(){
$(this).addClass("active").siblings().removeClass("active");
var countType = $("input[name='type']:checked").val();
App.loadLineChar(App.level,App.districtName);
});
//下载
function dowlond(){
$(".dow").off("click");
var type=$(this).data("type");
var data;
var name;
if(type=="0"){
name='全国';
data={'全国':App.activeData}
}else if(type=="1"){
name='保护区';
data={'保护区':App.reserveData}
}
$.ajax({
url: getRootPath() + 'gis/national/exportExcelInfo',
dataType: 'json',
data:{
tableData:JSON.stringify(data),
tables:name
},
type: 'post',
//async: true,
success: function(data) {
$(".dow").click(dowlond);
window.open(getRootPath()+'gis/common/downLoadFile?serverPath='+data.result);
},
error: function(err) {
console.log(err);
}
});
}
$(".dow").click(dowlond);

//切换年份加载对应年份服务
form.on("select(year)",function(data){
// 2019上半年数据
if (data.value == "201901") {
// $(".YJJCLayer").attr("checked",'false');
$(".layer_Control").show();
}else {
if (App.map.getLayer("2019pre" + 0)) {
App.map.removeLayer(App.map.getLayer("2019pre" + 0));
}
if (App.map.getLayer("2019pre" + 1)) {
App.map.removeLayer(App.map.getLayer("2019pre" + 1));
}
if (App.map.getLayer("2019pre" + 2)) {
App.map.removeLayer(App.map.getLayer("2019pre" + 2));
}
$(".layer_Control").hide();
}
//设置地图年份
var leftYear;
if(data.value.substr(4,2) == "01"){
leftYear = Number(data.value.slice(0,4)-1)
$(".map_year_select1").val(leftYear+"02");
$(".map_year_select1").trigger("change");
$(".map_year_select2").val(data.value);
$(".map_year_select2").trigger("change");
}else if(data.value.substr(4,2) == "02"){
$(".map_year_select1").val(data.value.slice(0,4)+"01");
$(".map_year_select1").trigger("change");
$(".map_year_select2").val(data.value);
$(".map_year_select2").trigger("change");
}


chinaZoneLayer=Config["countryZone"+(data.value)];

if($(".reservelevel").is(':visible')){
App.reserveChange(reserveName);
}
//删除上一次的保护区和人类活动
for(var i = 0; i<App.leftMap.graphicsLayerIds.length;i++){
if(App.leftMap.graphicsLayerIds[i].indexOf("process") != -1){
App.leftMap.removeLayer(App.leftMap.getLayer(App.leftMap.graphicsLayerIds[i]));
}
}
for(var i = 0; i<App.leftMap.layerIds.length;i++){
if(App.leftMap.layerIds[i].indexOf("countryZone") != -1){
App.leftMap.removeLayer(App.leftMap.getLayer(App.leftMap.layerIds[i]));
}
}
for(var i = 0; i<App.rightMap.graphicsLayerIds.length;i++){
if(App.rightMap.graphicsLayerIds[i].indexOf("process") != -1){
App.rightMap.removeLayer(App.rightMap.getLayer(App.rightMap.graphicsLayerIds[i]));
}
}
for(var i = 0; i<App.rightMap.layerIds.length;i++){
if(App.rightMap.layerIds[i].indexOf("countryZone") != -1){
App.rightMap.removeLayer(App.rightMap.getLayer(App.rightMap.layerIds[i]));
}
}

//人类活动数据
nowyear=data.value;
require(["esri/layers/FeatureLayer","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/WebTiledLayer",'esri/layers/TileInfo',],
function(FeatureLayer,ArcGISDynamicMapServiceLayer,WebTiledLayer,TileInfo){
leftLayer=new ArcGISDynamicMapServiceLayer(Config["countryZone"+$("#year").val()],{
id:"countryZone"+nowyear,
opacity:0.4
});
rightLayer=new ArcGISDynamicMapServiceLayer(Config["countryZone"+$("#year").val()],{
id:"countryZone"+nowyear,
opacity:0.4
});
App.leftMap.addLayer(leftLayer);
App.rightMap.addLayer(rightLayer);
//清除边界服务，重新添加
App.map.removeLayer(App.boundaryLayer);
App.boundaryLayer=new esri.layers.FeatureLayer(chinaZoneLayer+"/0",{
outFields: ["*"],
opacity:0.6,
visible : false
});
App.boundaryLayer.setRenderer(App.uniqueRenderBoundary);
App.map.addLayer(App.boundaryLayer);
$(".btn-search").trigger("click");
//自然保护区点击事件处理
App.boundaryLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#mapContainer",App.map.toScreen(evt.mapPoint).x,App.map.toScreen(evt.mapPoint).y);
});

var val=data.value;
if($("#year").val().substr(4,2) == "01"){
leftYear = Number($("#year").val().slice(0,4)-1) +"02"
rightYear = data.value;

}else if($("#year").val().substr(4,2) == "02"){
leftYear = Number($("#year").val().slice(0,4)) +"01"
rightYear = data.value;
}

var leftactiveLayer=new FeatureLayer(Config["process"+$("#year").val()]+"/0",{
outFields: ["一级类型","二级类型","区域名称","功能分区","变化情况","位置"],
id:"process"+$("#year").val(),
opacity:0.6
});
leftactiveLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map1",App.leftMap.toScreen(evt.mapPoint).x,App.leftMap.toScreen(evt.mapPoint).y);
});
var rightactiveLayer=new FeatureLayer(Config["process"+ $("#year").val()]+"/0",{
outFields:["一级类型","二级类型","区域名称","功能分区","变化情况","位置"],
id:"process" + $("#year").val(),
opacity:0.6
});
rightactiveLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map2",App.rightMap.toScreen(evt.mapPoint).x,App.rightMap.toScreen(evt.mapPoint).y);
});

App.leftMap.addLayer(leftactiveLayer,5);
App.rightMap.addLayer(rightactiveLayer,5);
leftactiveLayer.setRenderer(App.uniqueRender);
rightactiveLayer.setRenderer(App.uniqueRender);

})

});

//2019应急监测图层选择
$(".YJJCLayer").click(function(){
var checkNum = $(this).data("layer");
if(this.checked){
addYJJCByCheck(Config.YJJC2019+ "/" +checkNum, checkNum);
}else {
App.map.removeLayer(App.map.getLayer("2019pre" + checkNum));
}
});
});
function addYJJCByCheck(url, num){
require([
'esri/layers/FeatureLayer',
'esri/symbols/SimpleFillSymbol',
'esri/symbols/SimpleLineSymbol',
'esri/renderers/SimpleRenderer',
"esri/tasks/query",
'esri/Color',
], function (FeatureLayer, SimpleFillSymbol, SimpleLineSymbol, SimpleRenderer, Query, Color) {
if (App.map.getLayer("2019pre" + num)) {
App.map.removeLayer(App.map.getLayer("2019pre" + num));
}

var exampleLayer = new FeatureLayer(url, {
id: "2019pre" + num
});
App.map.addLayer(exampleLayer);
var riverLayerSymbol = new SimpleFillSymbol(
SimpleFillSymbol.STYLE_SOLID,
new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
new Color([255,0,0]), 1), new Color([255,0,0,0.5])
);
var simpleRender = new SimpleRenderer(riverLayerSymbol);
exampleLayer.setRenderer(simpleRender);

var graphics = exampleLayer.graphics;

var query = new Query();
query.outFields = ["*"];
//空间参考信息
query.outSpatialReference = App.map.spatialReference;
exampleLayer.queryFeatures(query, function(res) {
var geometry = res.features[i].geometry
var center = geometry.getExtent().getCenter();
App.map.centerAndZoom(center, 13);
});
});
}
//二维地图操作相关
var App = {
//当前地图等级,0为全国督察区，1位省份，
level : 0,
colorArray : [ "#CBD1F7", "#BEE8FF", "#D5F2C9", "#DCBEFA", "#C2F9EB", "#CBD2F7" ], //图例和地图渲染颜色
chartColorArray : [ "#5AA4D2", "#E36235", "#ff6623" ],
numBreaks : [], //数值分段
legendBreaks : [], //图例分段
dataList : [], //接口返回的业务
districtName : "全国", //选择的区划名称
year : new Date().getFullYear() - 1,
nowCondition : {},
historyCondition : [],


init : function() {
require(["../../mapTools/map.js", "esri/map", "../../mapTools/draw.js","../../mapTools/Loading.js", "../../mapTools/newTimeAxisCreator.js",
"esri/layers/ArcGISDynamicMapServiceLayer",
"esri/symbols/SimpleMarkerSymbol",
"esri/symbols/SimpleLineSymbol", "esri/renderers/UniqueValueRenderer",
"esri/symbols/SimpleFillSymbol", "esri/Color",
"esri/layers/GraphicsLayer", "esri/layers/FeatureLayer",
"esri/layers/LabelClass", "esri/symbols/TextSymbol",
"esri/geometry/Extent",
"esri/SpatialReference",
'esri/layers/TileInfo',
"esri/layers/WMTSLayerInfo",
'esri/layers/WebTiledLayer',
"esri/symbols/Font", "esri/dijit/InfoWindow",
"esri/geometry/Point"],
function(map,Map, Draw, Loading, newTimeAxisCreator, ArcGISDynamicMapServiceLayer, SimpleMarkerSymbol,
SimpleLineSymbol, UniqueValueRenderer, SimpleFillSymbol, Color, GraphicsLayer, FeatureLayer, LabelClass, TextSymbol,Extent,SpatialReference,TileInfo,WMTSLayerInfo,WebTiledLayer, Font, InfoWindow,Point) {
App.symbolFill = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#FFFF00"), 1), new Color([0, 0, 0,0]));
App.symbolFill2 = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#FFD700"), 1), new Color([0, 0, 0,0]));
App.symbolFill3 = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#FF0000"), 5), new Color([ 0, 0, 0, 0 ]));
//保护区边界高亮显示时使用
App.symbolFill4 = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("red"), 1), new Color([ 0, 0, 0, 0 ]));
App.colorArray.forEach(function(item, i) {
var name = "symbolProvince" + i;
App[name] = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#e2a04b"), 1), new Color(item));
});
//人类活动颜色
App.uniqueRender = new UniqueValueRenderer(App.symbolFill3, "一级类型");
$.each(activeColor,function(k,v){
App.uniqueRender.addValue(k, new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color(v), 5), new Color([ 0, 0, 0, 0])));
});
App.uniqueRenderBoundary = new UniqueValueRenderer(App.symbolFill, "功能分区");
dmcolor.forEach(function(item,index){
var simpf =new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#fff"), 0.5), new Color(item));
App.uniqueRenderBoundary.addValue(dmname[index], simpf);
});
var obj = new map({
extent : Config.fullMapExtent,
tileLayer : Config.layerUrl_worldbase,
imgLayer : Config.layerUrl_worldImg,
mapId : "mapContainer",
vector_id : "base_vector",
img_id : "base_img"
}).init();

App.map = obj.map;
//鹰眼图
App.overView = obj.overView;
//地图查询loading框
App.loading = new Loading();
//初始化绘图工具
App.draw = new Draw({
mapId : "mapContainer"
});
//出图重新绑定
$('#gj_div div:last-child').removeAttr('onclick');
$('#gj_div div:last-child').on('click', function() {
UI.mapExport("basestatic");
});

// 首先我们设定瓦片信息，天地图经纬度地图的切片信息全部使用该信息设定
tileInfo = new TileInfo({
dpi: 96,
rows : 256,
cols : 256,
compressionQuality : 0,
origin : {
x : -180,
y : 90
},
spatialReference : {
wkid : 4326
},
lods : [
{level : 2,levelValue: 2, resolution : 0.3515625, scale : 147748796.52937502},
{level : 3,levelValue: 3, resolution : 0.17578125, scale : 73874398.264687508},
{level : 4,levelValue: 4,resolution : 0.087890625, scale : 36937199.132343754},
{level : 5,levelValue: 5, resolution : 0.0439453125, scale : 18468599.566171877},
{level : 6,levelValue: 6, resolution : 0.02197265625, scale : 9234299.7830859385},
{level : 7,levelValue: 7, resolution : 0.010986328125, scale : 4617149.8915429693},
{level : 8,levelValue: 8, resolution : 0.0054931640625, scale : 2308574.9457714846},
{level : 9,levelValue: 9, resolution : 0.00274658203125, scale : 1154287.4728857423},
{level : 10,levelValue: 10, resolution : 0.001373291015625, scale : 577143.73644287116},
{level : 11,levelValue: 11, resolution : 0.0006866455078125, scale : 288571.86822143558},
{level : 12,levelValue: 12, resolution : 0.00034332275390625, scale : 144285.93411071779},
{level : 13,levelValue: 13, resolution : 0.000171661376953125, scale : 72142.967055358895},
{level : 14,levelValue: 14, resolution : 8.58306884765625e-005, scale : 36071.483527679447},
{level : 15,levelValue: 15, resolution : 4.291534423828125e-005, scale : 18035.741763839724},
{level : 16,levelValue: 16, resolution : 2.1457672119140625e-005, scale : 9017.8708819198619},
{level : 17,levelValue: 17, resolution : 1.0728836059570313e-005, scale : 4508.9354409599309},
{level : 18,levelValue: 18, resolution : 5.3644180297851563e-006, scale : 2254.4677204799655},
{ level: 19,levelValue: 19, resolution: 2.68220901489257815e-006, scale: 1127.23386023998275 },
{ level: 20,levelValue: 2, resolution: 1.341104507446289075e-006, scale: 563.616930119991375 }
]
})
var layer1 = WebTiledLayer('http://{subDomain}.tianditu.gov.cn/DataServer?T=img_c&x={col}&y={row}&l={level}&tk=2dc92d42654bd564ce1fc395f34d591c',{
subDomains: ['t0','t1','t2','t3','t4','t5','t6','t7'],
tileInfo: tileInfo
})
var layer2 = WebTiledLayer('http://{subDomain}.tianditu.gov.cn/DataServer?T=img_c&x={col}&y={row}&l={level}&tk=2dc92d42654bd564ce1fc395f34d591c',{
subDomains: ['t0','t1','t2','t3','t4','t5','t6','t7'],
tileInfo: tileInfo
})

//加载高分影像服务
var tileExtent = new Extent(-180, -90, 180, 90, new SpatialReference({ wkid: 4326 }));
var layerInfo = new WMTSLayerInfo({
tileInfo: tileInfo,
fullExtent: tileExtent,
initialExtent: tileExtent,
identifier: "hbb",
tileMatrixSet: "c",
format: "png",
style: "default"
});
var resourceInfo = {
version: "1.0.0",
layerInfos: [layerInfo],
copyright: "ZKYT"
};
var options = {
serviceMode: "KVP",
resourceInfo: resourceInfo,
layerInfo: layerInfo
};
var wmtsLayerAM,wmtsLayerPM;


if($("#year").val().substr(4,2) == "02"){

wmtsLayerAM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+$("#year").val().substr(0,4)+"AM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerAM',
visible : true
});
wmtsLayerPM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+$("#year").val().substr(0,4)+"PM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerPM',
visible : true
});
}else if($("#year").val().substr(4,2) == "01"){
var yearLayer = Number($("#year").val().substr(0,4)) - 1;
wmtsLayerAM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+yearLayer+"PM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerAM',
visible : true
});
wmtsLayerPM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+$("#year").val().substr(0,4)+"AM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerPM',
visible : true
});
//http://60.247.54.42:8088/WMTS2019AM_gBHQ/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}
if($("#year").val().substr(0,4)=="2019"){
wmtsLayerPM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF2019AM_gBHQ/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerPM',
visible : true
});
}
}






//App.map.addLayer(wmtsLayer);
//添加督察区服务
App.InspectorLayer = new FeatureLayer(Config.layerUrl_Inspector + "/0", {
showLabels : true,
outFields : [ "*" ],
visible : true
});
//添加省份服务
App.provinceLayer = new FeatureLayer(Config.administrativeArea_SS + "/0", {
id:'provinceLayer',
showLabels : true,
outFields : [ "*" ],
visible : false
});
//保护区边界数据
App.boundaryLayer = new FeatureLayer(chinaZoneLayer+ "/0", {
id:'chinaZoneLayer',
outFields : [ "*" ],
opacity:0.6,
visible : true
});
App.boundaryLayer.setDefinitionExpression("省份=''");
//人类活动数据
App.activeLayer = new FeatureLayer(processLayer+ "/0", {
id:'processLayer',
outField : [ "*" ],
opacity:0.8,
visible : false
});
var render = new esri.renderer.SimpleRenderer(App.symbolFill);
var render2 = new esri.renderer.SimpleRenderer(App.symbolFill2);
var render3 = new esri.renderer.SimpleRenderer(App.symbolFill3);
App.render3=render3;
//App.InspectorLayer.setRenderer(render);
//App.provinceLayer.setRenderer(render2);
App.activeLayer.setRenderer(render3);
App.map.addLayer(App.InspectorLayer);
App.map.addLayer(App.provinceLayer);
App.map.addLayer(App.boundaryLayer);
App.map.addLayer(App.activeLayer);
//App.map.removeLayer(App.map.getLayer('base_vector'));
//图层绑定双击时间
App.InspectorLayer.on("dbl-click", dblInspectorClick);
App.provinceLayer.on("dbl-click", dblprovinceClick);
function dblInspectorClick(evt) {
//保护区名称选项清除
$("#zoneName").val("");
evt.stopPropagation();
App.level = evt.graphic.attributes.DISTRICTLE;
var districtName = evt.graphic.attributes.DISTRICTNA;
App.districtName = districtName;
$(".select_input").find("span").text(districtName);
//记录当前条件,若为用户操作，则为false
App.nowCondition.level = App.level;
App.nowCondition.districtName = App.districtName;
App.historyCondition.unshift(App.cloneObject(App.nowCondition));
$(".btn-search").trigger("click");
App.flyToExtent(App.level, App.districtName);
}
function dblprovinceClick(evt) {
//保护区名称选项清除
$("#zoneName").val("");
evt.stopPropagation();
var changeZB = $(".changeZB").val(); //统计指标
if (changeZB != "natureNum") {
App.level = evt.graphic.attributes.DISTRICTLE;
var districtName = evt.graphic.attributes.DISTRICTNA;
App.districtName = districtName;
$(".btn-search").trigger("click");
App.flyToExtent(App.level, App.districtName);
}
$(".select_input").find("span").text(evt.graphic.attributes.DISTRICTNA);
}
//保护区俩个地图
var obj1 = new Map("map1", {
/*basemap : basemap,*/
//extent: Config.fullMapExtent,
zoom :4,
maxZoom:15,
logo : false,
center : [113.663221, 34.7568711],
slider : false,
showLabels:true,
double:true

});
var obj2 = new Map("map2", {
/*basemap : basemap,*/
//extent: Config.fullMapExtent,
zoom :4,
maxZoom:15,
logo : false,
center : [113.663221, 34.7568711],
slider : false,
showLabels:true,
double:true

});


var leftMap=obj1;
var rightMap=obj2;
var leftLayer,rightLayer;

leftLayer=new ArcGISDynamicMapServiceLayer(Config["countryZone"+$("#year").val()],{
id:"countryZone"+nowyear,
opacity:0.4
});
rightLayer=new ArcGISDynamicMapServiceLayer(Config["countryZone"+$("#year").val()],{
id:"countryZone"+nowyear,
opacity:0.4
});




//增加保护区定位 边界高亮的图层
App.graphicLeftLayer=new GraphicsLayer();
App.graphicRightLayer=new GraphicsLayer();
App.leftMap=leftMap;
App.rightMap=rightMap;


//添加最新一期年份的人类活动数据
if($("#year").val().substr(4,2) == "01"){
leftYear = Number($("#year").val().slice(0,4)-1) +"02"
rightYear = $("#year").val();

}else if($("#year").val().substr(4,2) == "02"){
leftYear = Number($("#year").val().slice(0,4)) +"01"
rightYear = $("#year").val();
}
var leftactiveLayer=new FeatureLayer(Config["process"+$("#year").val()]+"/0",{
outFields: ["一级类型","二级类型","区域名称","功能分区","变化情况","位置"],
id:"process"+leftYear,
opacity:0.6
});
leftactiveLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map1",App.leftMap.toScreen(evt.mapPoint).x,App.leftMap.toScreen(evt.mapPoint).y);
});
var rightactiveLayer=new FeatureLayer(Config["process"+$("#year").val()]+"/0",{
outFields:["一级类型","二级类型","区域名称","功能分区","变化情况","位置"],
id:"process"+rightYear,
opacity:0.6
});
rightactiveLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map2",App.rightMap.toScreen(evt.mapPoint).x,App.rightMap.toScreen(evt.mapPoint).y);
});
leftactiveLayer.setRenderer(App.uniqueRender);
rightactiveLayer.setRenderer(App.uniqueRender);
App.leftMap.addLayer(layer1);
App.rightMap.addLayer(layer2);

App.leftMap.addLayer(leftactiveLayer,5);
App.rightMap.addLayer(rightactiveLayer,5);
App.leftMap.addLayer(wmtsLayerAM);
App.rightMap.addLayer(wmtsLayerPM);
App.leftMap.addLayer(App.graphicLeftLayer,4);
App.leftMap.addLayer(leftLayer,3);
App.rightMap.addLayer(App.graphicRightLayer,4);
App.rightMap.addLayer(rightLayer,3);

App.point = new Point('','',App.leftMap.spatialReference);

App.activeLend=function(){
//加载图例
var lendcolor=[];
var lendname=[];
$.each(activeColor,function(k,v){
lendcolor.unshift(v);
lendname.unshift(k);
});
UI.getChartLegend(lendcolor,lendname,"图例");
}

//返回上级
$(".return").click(function(){
//保护区名称选项清除
$("#zoneName").val("");
reserveLevel=false;
$(".reservelevel").hide();
$(".firstLevel").show();
$(".reserve").hide();
$("#mapContainer").show();
App.loadLineChar(App.level,App.districtName);
App.activeChange(App.level);

});
//左右地图联动
var leftFlag = true, rightFlag = true;
App.leftMap.on("extent-change", function () {
if (leftFlag) {
App.rightMap.setExtent(App.leftMap.extent);
rightFlag = false;
} else {
leftFlag = true;
}
});
App.rightMap.on("extent-change", function () {
if (rightFlag) {
App.leftMap.setExtent(App.rightMap.extent);
leftFlag = false;
} else {
rightFlag = true;
}
});
//图层单击事件
leftLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map1",App.leftMap.toScreen(evt.mapPoint).x,App.leftMap.toScreen(evt.mapPoint).y);
});

rightLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map2",App.rightMap.toScreen(evt.mapPoint).x,App.rightMap.toScreen(evt.mapPoint).y);
});

//搜索事件
$(".btn-search").on("click", function() {
$(".right-top").show();
//清除原有柱状图
if (UI.chartLayer) {
UI.chartLayer._clearAll();
}
if(districtNameTZ != 'null' && plevelTZ == '1'){
$(".select_input").find("span").text(districtNameTZ);
App.level = 2;
App.districtName = districtNameTZ
App.flyToExtent(App.level,districtNameTZ);
}

//如果有保护区名称，进入保护区级别
if($("#zoneName").val()){
reserveLevel=true;
App.queryZoneDetail($("#zoneName").val());
App.loadCompareImage($("#zoneName").val());
}else if(reserveLevel){
App.reserveChange(reserveName);
}else{
App.activeChange(App.level);
}


});
$(".btn-search").trigger("click");
$(".tabDiv").on("click", function() {
if ($(this).text() == "数量") {
baseZb = "num";
App.activeChange(App.level);
$("#countNum").trigger("click");
} else {
baseZb = "area";
App.activeChange(App.level);
$("#areaNum").trigger("click");
}
})

var MYear = $('.map_year_select1').val();

if(App.leftMap.getLayer("leftactiveLayer")){
App.leftMap.removeLayer(App.leftMap.getLayer("leftactiveLayer"))
}
var symbolFillL = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#FF0000"), 5), new Color([ 0, 0, 0, 0 ]));
//人类活动颜色
var uniqueRenderL = new UniqueValueRenderer(symbolFillL, "一级类型");
var leftactiveLayer=new FeatureLayer(Config["process"+MYear]+"/0",{
outFields: ["一级类型","二级类型","区域名称","功能分区","变化情况","位置"],
id:"leftactiveLayer",
opacity:0.6
});
leftactiveLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map1",App.leftMap.toScreen(evt.mapPoint).x,App.leftMap.toScreen(evt.mapPoint).y);
});
App.leftMap.addLayer(leftactiveLayer,2);
leftactiveLayer.setRenderer(uniqueRenderL);

if(App.rightMap.getLayer("rightactiveLayer")){
App.rightMap.removeLayer(App.rightMap.getLayer("rightactiveLayer"))
}
var symbolFillR = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color("#FF0000"), 5), new Color([ 0, 0, 0, 0 ]));
//人类活动颜色
var uniqueRenderR = new UniqueValueRenderer(symbolFillR, "一级类型");
var rightactiveLayer=new FeatureLayer(Config["process"+MYear]+"/0",{
outFields:["一级类型","二级类型","区域名称","功能分区","变化情况","位置"],
id:"rightactiveLayer",
opacity:0.6
});
rightactiveLayer.on("click",function(evt){
App.loadDojoPanel("保护区详情",evt.graphic.attributes,"#map2",App.rightMap.toScreen(evt.mapPoint).x,App.rightMap.toScreen(evt.mapPoint).y);
});

App.rightMap.addLayer(rightactiveLayer,2);
rightactiveLayer.setRenderer(uniqueRenderR);

addBaseLayerByYear(MYear, "left");
addBaseLayerByYear(MYear, "right");

$('.map_year_select1').change(function(){
var MYear = $(this).val();
addBaseLayerByYear(MYear, "left");
});
$('.map_year_select2').change(function(){
var MYear = $(this).val();
addBaseLayerByYear(MYear, "right");
});
// 切换年份
function addBaseLayerByYear(selectYear, flag){

if (flag == "left") {
require(["esri/layers/FeatureLayer","esri/layers/WebTiledLayer",'esri/layers/TileInfo'],function(FeatureLayer,WebTiledLayer,TileInfo){
var wmtsLayerAM;
if(selectYear== '201901'){
wmtsLayerAM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF2019AM_gBHQ/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerAM',
visible : true
});
}else if(selectYear== '201902'){
wmtsLayerAM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF2019PM_gBHQ/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerAM',
visible : true
});
}else{
if(selectYear.substr(4,2)=="01"){
wmtsLayerAM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+selectYear.substring(0,4)+"AM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerAM',
visible : true
});
}else{
wmtsLayerAM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+selectYear.substring(0,4)+"PM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerAM',
visible : true
});
}

}

if(App.leftMap.getLayer("wmtsLayerAM")){
App.leftMap.removeLayer(App.leftMap.getLayer("wmtsLayerAM"))
}
App.leftMap.addLayer(wmtsLayerAM, 1);
});
}

if (flag == "right") {
require(["esri/layers/FeatureLayer","esri/layers/WebTiledLayer",'esri/layers/TileInfo'],function(FeatureLayer,WebTiledLayer,TileInfo){
var wmtsLayerPM;
if(selectYear== '201901'){
wmtsLayerPM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF2019AM_gBHQ/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerPM',
visible : true
});
}else if(selectYear== '201902'){
wmtsLayerPM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF2019PM_gBHQ/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerPM',
visible : true
});
}else{
if(selectYear.substr(4,2)=="01"){
wmtsLayerPM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+selectYear.substring(0,4)+"AM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerPM',
visible : true
});
}else{
wmtsLayerPM = new WebTiledLayer("http://60.247.54.36:8088/HBBGF"+selectYear.substring(0,4)+"PM/GetData?layer=hbb&style=default&tilematrixset=c&Service=WMTS&Request=GetTile&Version=1.0.0&Format=png&TileMatrix={level}&TileCol={col}&TileRow={row}",{
tileInfo: tileInfo,
id:'wmtsLayerPM',
visible : true
});
}

}
if(App.rightMap.getLayer("wmtsLayerPM")){
App.rightMap.removeLayer(App.rightMap.getLayer("wmtsLayerPM"))
}
App.rightMap.addLayer(wmtsLayerPM, 1);
});
}
}

// 年份选择为201901 出现图层控制
if($("#year").val() == "201901"){
$(".layer_Control").show();
}
});
},
//获取业务值，进行分段、生成图例
getLegend : function(chartList) {
//根据业务值和颜色的数量分段
App.numBreaks = UI.getDataBreaks(chartList, 5);
App.legendBreaks = [ {
start : 0,
end : App.numBreaks[1],
color : new esri.Color(App.colorArray[0])
},
{
start : App.numBreaks[1],
end : App.numBreaks[2],
color : new esri.Color(App.colorArray[1])
},
{
start : App.numBreaks[2],
end : App.numBreaks[3],
color : new esri.Color(App.colorArray[2])
},
{
start : App.numBreaks[3],
end : App.numBreaks[4],
color : new esri.Color(App.colorArray[3])
},
{
start : App.numBreaks[4],
end : App.numBreaks[5] + 1,
color : new esri.Color(App.colorArray[4])
} ];
//创建图例，传入如上对象
//UI.createLegend(App.legendBreaks,"保护区数量(个)");
//UI.loadmapChart(App.map,"饼状图",["#5AA4D2", "#E36235"],"data",["数量","面积"],"NAME",chartList);
},
layerRender2 : function(evt) {
//level为1 双击督察区筛选完毕，level为2，双击省份筛选完毕
if (App.level == "1") {
var graphic;
var data;
for (var i = 0; i < App.provinceLayer.graphics.length; i++) {
graphic = App.provinceLayer.graphics[i];
//测试用上
//data=App.getGraphicValue(graphic.attributes.DISTRICTNA);
//
if (i < App.colorArray.length) {
graphic.setSymbol(App.symbolFill.setColor(App.colorArray[i]));
} else {
graphic.setSymbol(App.symbolFill.setColor(App.colorArray[App.colorArray.length - 1]));
}

}
} else if (App.level == "2") {
var graphic;
var data;
for (var i = 0; i < App.provinceLayer.graphics.length; i++) {
graphic = App.provinceLayer.graphics[i];
graphic.setSymbol(App.symbolFill.setColor([ 0, 0, 0, 0 ]));
}
}
},
//根据名称获取要素对应业务值
getGraphicValue : function(key) {
for (var i = 0; i < App.dataList.length; i++) {
if (App.dataList[i].district.indexOf(key) > (-1)) {
return App.dataList[i].val;
}
}
},
//初始化行政区划
getDivision : function() {
UI.stopPropagation();
if (UI.versionID == "") {
App.loading.show();
//树形区划初始区域
var initTreeData = [];
initTreeData.push({
name : "全国",
open : true,
isParent : true,
checked : true,
level : "0",
PARAMNAME : "全国"
});
var left = $(this).offset().left,
top = $(this).offset().top + $(this).outerHeight();
UI.getDivision({
left : left,
top : top,
type : "radio",
divId : "body",
treeData : initTreeData,
fn : function(evt) {

}
});
} else {
if ($("#" + UI.versionID).is(':visible')) $("#" + UI.versionID).hide();
else $("#" + UI.versionID).show();
}
},
//返回上级操作
returnToBack : function() {
$("#zoneName").val("");
$(".right-top").css("height", "50%");
$(".right-bottom").show();
$(".right-top").show();

//督察区切换为省份时候
if(isSupervision){
if (App.historyCondition.length > 0) {
if (App.level == 2) {
App.level = App.historyCondition[0].level;
App.districtName = App.historyCondition[0].districtName;
} else if (App.level == 1) {
App.level = 0;
App.districtName = '全国';
App.historyCondition.length = 0;
}
App.activeChange(App.level);
App.flyToExtent(App.level, App.districtName);
}
}else{
App.level=4;
App.activeChange(4);
App.flyToExtent(0);
}
},
//点击地图显示弹出框dojopanel
loadDojoPanel: function(title, attributes,id,x,y) {
if ($("#detailContent")) {
$("#detailContent").remove();
}
require(["../../mapTools/Dialog.js"],
function(Dialog) {
var html = "<div class='Dialog_detailmoveDiv' style='width:100%;height:100%;'>";
  html += '<table id="disaster-info-table" class="Dialog_table">';
    $.each(attributes,function(k,v){
    html+='<tr><td>'+k+'</td><td>'+v+'</td></tr>';
    });
    html += '</table></div>';
App.dialogDojoPanel = new Dialog({
type: 1,
top: y,
left: x,
width: 320,
//height:290,
tittleWidth: '100%',
tittle: '详细信息',
Dialog_content: html,
id: "detailContent",
mainDivId: id,
changeTitle: true,
dragble: true
}).init();
});
},
//javavscript中点的克隆
cloneObject : function(obj) {
var o = obj.constructor === Array ? [] : {};
for (var i in obj) {
if (obj.hasOwnProperty(i)) {
o[i] = typeof obj[i] === "object" ? cloneObject(obj[i]) : obj[i];
}
}
return o;
},
fillInfoWindowContent : function(attributes) {
var html = "<table class='table-container'><tbody>";
$.each(attributes, function(k, v) {
html += '<tr><td>' + k + '</td><td>' + v + '</td></tr>'
});
html += "</tbody>";
  return html;
  },
  //控制右侧面板切换
  controlRightList : function() {
  if (App.level == 0 || App.level == 1) {
  $(".right-top,.right-bottom").css("display", "block");
  $(".zoneInfo").css("display", "none");
  } else {
  $(".right-top,.right-bottom").css("display", "none");
  $(".zoneInfo").css("display", "block");
  }
  },
  loadQipaoRender : function(data, type) {
  if (App.map.getLayer("zoneGraphicLayer")) {
  App.map.removeLayer(App.map.getLayer("zoneGraphicLayer"));
  }
  var zoneGraphicLayer = new esri.layers.GraphicsLayer({
  id : "zoneGraphicLayer"
  });
  App.map.addLayer(zoneGraphicLayer);
  var picBaseUrl = "../../mapTools/images/";
  //面积进行分段
  beginNum=0;
  beginArea=0;
  dataSymbolSize=0;
  citySymbolSize=0;
  if(App.level==1||App.level==0){
  beginNum=50;
  beginArea=90;
  dataSymbolSize="18px";
  citySymbolSize="16px";
  }else{
  beginNum=40;
  beginArea=80;
  dataSymbolSize="15px";
  citySymbolSize="13px";
  }
  if (type == "num") {
  var renderer = new esri.renderer.ClassBreaksRenderer(App.symbolFill, "count");
  var delt1 = new esri.symbol.PictureMarkerSymbol(picBaseUrl
  + "50.png", beginNum, beginNum).setOffset(0, 7);
  var delt2 = new esri.symbol.PictureMarkerSymbol(picBaseUrl
  + "56.png", beginNum+6, beginNum+6).setOffset(0, 7);
  var delt3 = new esri.symbol.PictureMarkerSymbol(picBaseUrl
  + "62.png", beginNum+12, beginNum+12).setOffset(0, 7);
  var delt4 = new esri.symbol.PictureMarkerSymbol(picBaseUrl
  + "68.png", beginNum+18, beginNum+18).setOffset(0, 7);
  renderer.addBreak(App.legendBreaks[0].start, App.legendBreaks[0].end, delt1);
  renderer.addBreak(App.legendBreaks[1].start, App.legendBreaks[1].end, delt2);
  renderer.addBreak(App.legendBreaks[2].start, App.legendBreaks[2].end, delt3);
  renderer.addBreak(App.legendBreaks[3].start, App.legendBreaks[4].end, delt4);
  zoneGraphicLayer.setRenderer(renderer);
  } else if (type == "area") {
  var delt1 = new esri.symbol.PictureMarkerSymbol(picBaseUrl + "sl.png", beginArea, beginArea-37);
  var renderer = new esri.renderer.SimpleRenderer(delt1);
  zoneGraphicLayer.setRenderer(renderer);
  }
  var srf = new esri.SpatialReference({
  wkid : 4326
  });
  data.forEach(function(item) {
  var obj = {};
  if (baseZb == "num") {
  obj.count = parseInt(item["ACTIVITYTOTAL"]);
  } else if (baseZb == "area") {
  obj.count = parseFloat(item["ACTIVITYTOTAL"]).toFixed(2);
  }

  var point = new esri.geometry.Point(item.x,
  item.y, srf);
  var graphic = new esri.Graphic(esri.geometry
  .geographicToWebMercator(point), null,
  obj);
  var symbol; //数据符号
  var symbolCity; //城市符号
  symbol = new esri.symbol.TextSymbol(String(obj.count),
  new esri.symbol.Font(dataSymbolSize,
  esri.symbol.Font.STYLE_NORMAL,
  esri.symbol.Font.VARIANT_NORMAL,
  "AdobeHeitiStd-Regular"),
  new esri.Color("#FFFFFF"));
  symbolCity = new esri.symbol.TextSymbol(String(item.NAME),
  new esri.symbol.Font(citySymbolSize,
  esri.symbol.Font.STYLE_NORMAL,
  esri.symbol.Font.VARIANT_NORMAL,
  "AdobeHeitiStd-Regular"),
  new esri.Color("#FFFFFF")).setOffset(0, -30);
  var graphicLabel = new esri.Graphic(esri.geometry
  .geographicToWebMercator(point), symbol);
  var graphicCity = new esri.Graphic(esri.geometry
  .geographicToWebMercator(point), symbolCity);
  zoneGraphicLayer.add(graphic);
  zoneGraphicLayer.add(graphicLabel);
  zoneGraphicLayer.add(graphicCity);
  });
  },
  //保护区动态变化
  reserveChange : function(name) {
  App.activeLend();
  $.ajax({
  url : getRootPath() + 'gis/human/activity/getHumanActivityDynamicCount',
  data : {
  year:$("#year").val(),
  level:'3',
  district:name,
  proZoneType:getCheckboxStr("baseType2"),//保护区类型
  humanActivityType:getCheckboxStr("humanActive"),
  peace:peace
  },
  type : 'post',
  dataType : "json",
  success : function(data) {

  var groupCount=[];
  $(".title").text(name+"监测保护区数量");
  //右侧上部内容
  $(".TOTALACTIVITYAREA").text(data.result.wholeCount.TOTALACTIVITYAREA); // 人类活动面积
  $(".ADDAREA").text(data.result.wholeCount.ADDAREA); // 新增面积
  $(".EXPANSIONAREA").text(data.result.wholeCount.EXPANSIONAREA); // 规模扩大面积
  $(".RATIO").text(data.result.wholeCount.RATIO); // 面积占比
  if (data.result.wholeCount.INCREASES > 0) {
  $(".picture").attr("src", "img/up.png");
  $(".INCREASES").text(data.result.wholeCount.INCREASES); // 增幅
  } else {
  $(".picture").attr("src", "img/down.png");
  $(".INCREASES").text(data.result.wholeCount.INCREASES * (-1));
  }
  //遍历元素名称和元素值数组，得到南丁格尔玫瑰图中的数据
  var groupData;
  if(baseZb=="num"){
  groupData=data.result.groupNumberCount;
  }else if(baseZb=="area"){
  groupData=data.result.groupAreaCount;
  }
  for (var i = 0; i <groupData.NAME.length; i++) {
  groupCount.push({
  name : groupData.NAME[i],
  value : groupData.VALUE[i]
  });
  }
  //获取人类活动图层颜色
  /*	var list=[]
  App.activeLayer.renderer.forEach(function(v){
  var color=v.symbol.color;
  var obj={v.label:"rgb("+color.r+","+color.g+","+color.b+")"}
  list.push(obj)
  });
  App.activeColor=list;
  */
  statistic.loadNDGE(groupCount,"container2",groupCount.NAME,"个");
  //列表
  var html="";
  //下载数据
  var dowlist=[]
  data.result.humamActivityList.forEach(function(v){
  var span="";
  if(v.PEACE.indexOf("实验区")!='-1'){
  span+="<span class='round' style='background-color:rgb(34,191,165)'>实</span>"
  }
  if(v.PEACE.indexOf("核心区")!='-1'){
  span+="<span class='round' style='background-color:rgb(3,166,220)'>核</span>"
  }
  if(v.PEACE.indexOf("缓冲区")!='-1'){
  span+="<span class='round' style='background-color:rgb(252,137,19)'>缓</span>"
  }

  html+=" <tr data-x='"+v.X+"'"+"  data-y='"+v.Y+"'><td>"+v.ADDRESS+"</td><td>"+v.TYPE1+"</td> <td>"+v.CHANGE+"</td><td>"+span+"</td></tr>"
  var obj={'名称':v.ADDRESS,'类型':v.TYPE1,'变化':v.CHANGE,'类型区':v.PEACE,}
  dowlist.push(obj);
  });
  //下载数据
  App.reserveData=dowlist;
  $(".humamActivityList").html(html);
  $(".activelist tr").click(function(){
  var name=$(this).find("td").eq(0).text();
  var x=$(this).data("x");
  var y=$(this).data("y");
  var layer=Config["countryZone"+($("#year").val())]+"/0";
  App.flyToExtents(x,y,App.leftMap);

  });

  },
  error : function() {
  alert("请求失败 ");
  }
  });


  },
  //人类活动动态变化
  activeChange : function(level) {
  App.loadLineChar(App.level,App.districtName);
  $.ajax({
  url : getRootPath() + 'gis/human/activity/getHumanActivityDynamicCount',
  data : {
  year : $("#year").val(),
  level : level,
  district : App.districtName,
  proZoneType : getCheckboxStr("baseType2"), //保护区类型
  humanActivityType : getCheckboxStr("humanActive"),
  peace : peace
  },
  type : 'post',
  dataType : "json",
  success : function(data) {

  var wholeCount; // 整体统计数据
  var number_AreaCount = []; // 数量/面积统计列表_数量
  var area_AreaCount = []; // 数量/面积统计列表_面积
  var groupCount = [];
  var year;
  //右侧上部左侧标题内容
  year = $("#year").find("option:selected").text();
  $("#titleTotal").text(year + App.districtName + "监测保护区数量");
  //右侧上部右侧标题内容
  if(data.status == "1001"){
  $("#number").text(data.result.wholeCount.TOTALCOUNT + "个");
  //右侧上部内容
  $("#TOTALACTIVITYAREA").text(data.result.wholeCount.TOTALACTIVITYAREA); // 人类活动面积
  $("#ADDAREA").text(data.result.wholeCount.ADDAREA); // 新增面积
  $("#EXPANSIONAREA").text(data.result.wholeCount.EXPANSIONAREA); // 规模扩大面积
  $("#RATIO").text(data.result.wholeCount.RATIO); // 面积占比
  if (data.result.wholeCount.INCREASES > 0) {
  $("#picture").attr("src", "img/up.png");
  $("#INCREASES").text(data.result.wholeCount.INCREASES); // 增幅
  } else {
  $("#picture").attr("src", "img/down.png");
  $("#INCREASES").text(data.result.wholeCount.INCREASES * (-1));
  }
  //遍历元素名称和元素值数组，得到南丁格尔玫瑰图中的数据
  var groupData;
  var unitStr;	// echart的弹出层中数据单位
  if (baseZb == "num") {
  groupData = data.result.groupNumberCount;
  unitStr = "个";
  for (var i = 0; i < groupData.NAME.length; i++) {
  groupCount.push({
  name : groupData.NAME[i],
  value : groupData.VALUE[i]
  });
  }
  } else if (baseZb == "area") {
  unitStr = "km<sup>2</sup>"
  groupData = data.result.groupAreaCount;
  for (var i = 0; i < groupData.NAME.length; i++) {
  groupCount.push({
  name : groupData.NAME[i],
  value : Number(groupData.VALUE[i]).toFixed(4)
  });
  }
  }
  //中部数据表格,到第三级没有保护区数量
  var html;
  if(isSupervision){
  if (App.level == 0 || App.level == 1) {
  html = "<thead><th>地区</th><th>涉及保护区</th><th>新增/扩大</th><th>占比(%)</th><th>增幅(%)</th></thead></tbody>" ;
  } else if (App.level == 2) {
  html = "<thead><th>地区</th><th>新增/扩大</th><th>占比(%)</th><th>增幅(%)</th></thead></tbody>" ;
  }
  }else{
  if (App.level == 2) {
  html = "<thead><th>地区</th><th>新增/扩大</th><th>占比(%)</th><th>增幅(%)</th></thead></tbody>" ;
  }else{
  html = "<thead><th>地区</th><th>涉及保护区</th><th>新增/扩大</th><th>占比(%)</th><th>增幅(%)</th></thead></tbody>" ;
  }

  }
  // 中部数据表格所需要的数据
  var dataList;
  if (baseZb == "num") {
  dataList = data.result.numberCount;
  UI.getChartLegend([ "#FFC434" ], [ "人类活动数量" ], "图例");
  } else if (baseZb == "area") {
  dataList = data.result.areaCount;
  UI.getChartLegend([ "#9C0759" ], [ "人类活动面积(km<sup>2</sup>)" ], "图例");
  }
  //下载数据集合
  var dowlist=[];

  dataList.forEach(function(item, index) {
  //下载数据的准备
  var obj;
  if(isSupervision){
  if (App.level == 0 || App.level == 1) {
  html += "<tr data-name=" + item.NAME + "><td a>" + item.NAME + "</td><td>" + parseInt(item.TOTALCOUNT) + "</td><td><div id='chart" + index + "' style='height:17px;width:100%;' data-expan=" + item.EXPANSION + " data-newadd=" + item.NEWADD + "  ></div></td><td>" + item.RATIO + "</td>";
    obj={'地区':item.NAME,'涉及保护区':item.TOTALCOUNT,'新增':item.NEWADD,'扩大':item.EXPANSION,'占比':item.RATIO,'增幅':item.INCREASES}
    } else {
    html += "<tr data-name=" + item.NAME + "><td>" + item.NAME + "</td><td><div id='chart" + index + "' style='height:17px;width:100%;'  data-expan=" + item.EXPANSION + " data-newadd=" + item.NEWADD + "></div></td><td>" + item.RATIO + "</td>";
    obj={'地区':item.NAME,'新增':item.NEWADD,'扩大':item.EXPANSION,'占比':item.RATIO,'增幅':item.INCREASES}
    }
    }else{
    if (App.level == 4) {
    html += "<tr data-name=" + item.NAME + "><td>" + item.NAME + "</td><td>" + parseInt(item.TOTALCOUNT) + "</td><td><div id='chart" + index + "' style='height:17px;width:100%;'  data-expan=" + item.EXPANSION + " data-newadd=" + item.NEWADD + "></div></td><td>" + item.RATIO + "</td>";
    obj={'地区':item.NAME,'涉及保护区':item.TOTALCOUNT,'新增':item.NEWADD,'扩大':item.EXPANSION,'占比':item.RATIO,'增幅':item.INCREASES}
    } else {
    html += "<tr data-name=" + item.NAME + "><td>" + item.NAME + "</td><td ><div id='chart" + index + "' style='height:17px;width:100%;'  data-expan=" + item.EXPANSION + " data-newadd=" + item.NEWADD + "></div></td><td>" + item.RATIO + "</td>";
    obj={'地区':item.NAME,'新增':item.NEWADD,'扩大':item.EXPANSION,'占比':item.RATIO,'增幅':item.INCREASES}
    }
    }
    // 由于增幅数据暂时获取不到，暂时用占比代替，后续获取成功时将item.RATIO替换为item.INCREASES即可
    if (item.INCREASES >=0) {
    html += "<td style='text-align:left;padding-left:10px;'><img src='img/up_center.png'><span>" + item.INCREASES + "</span></td></tr>";
  } else {
  html += "<td style='text-align:left;padding-left:10px;'><img src='img/down_center.png'><span>" + item.INCREASES * (-1) + "</span></td></tr>";
  }
  dowlist.push(obj);
  });
  App.activeData=dowlist
  $("#numberArea").html(html);
  $("#numberArea td").attr("align","center");
  //生成echart图

  dataList.forEach(function(item, index) {
  var chartLine2 = echarts.init(document.getElementById('chart' + index));
  var expand = $("#chart" + index).attr("data-expan");
  var newadd = $("#chart" + index).attr("data-newadd");
  if (baseZb == "num") {
  chartLine2.setOption(statistic.tdChart(item.DETAIL,"个","140px"));
  } else if (baseZb == "area") {
  chartLine2.setOption(statistic.tdChart(item.DETAIL,"km<sup>2</sup>","140px"));
  }
  });
  //底部南丁格尔玫瑰图
  statistic.loadNDGE(groupCount, "container", groupCount.NAME,unitStr);
  App.numBreaks = UI.getDataBreaks(data.result.numberCount, 5, "ACTIVITYTOTAL");
  App.legendBreaks = [ {
  start : 0,
  end : App.numBreaks[1],
  color : new esri.Color(App.colorArray[0])
  },
  {
  start : App.numBreaks[1],
  end : App.numBreaks[2],
  color : new esri.Color(App.colorArray[1])
  },
  {
  start : App.numBreaks[2],
  end : App.numBreaks[3],
  color : new esri.Color(App.colorArray[2])
  },
  {
  start : App.numBreaks[3],
  end : App.numBreaks[4],
  color : new esri.Color(App.colorArray[3])
  },
  {
  start : App.numBreaks[4],
  end : App.numBreaks[5] + 1,
  color : new esri.Color(App.colorArray[4])
  } ];
  //加载地图上气泡图
  App.loadQipaoRender(dataList,baseZb);
  //地图相关图层变化
  App.getVisibileMapServer();
  //点击保护区名称切换页面
  $("#numberArea tr").on("click",function(){
  if(App.level==2){
  App.queryZoneDetail($(this).data("name"));
  //加载影像
  App.loadCompareImage($(this).data("name"));
  }

  })

  }else{
  layer.msg(data.message);
  }
  },
  error : function() {
  alert("请求失败 ");
  }
  });

  /**
  * 点击切换数量数据表格
  */
  $('#count').on('click', function() {
  $('#count').css("background-color", "#D9E9F2");
  $('#areaOfCenter').css("background-color", "white");

  });

  /**
  * 点击切换面积数据表格
  */
  $('#areaOfCenter').on('click', function() {
  $('#count').css("background-color", "white");
  $('#areaOfCenter').css("background-color", "#D9E9F2");
  });

  },
  //根据保护区名称查询信息
  queryZoneDetail:function(name){
  App.graphicLeftLayer.clear();
  App.graphicRightLayer.clear();
  reserveLevel=true;
  $(".reservelevel").show();
  $(".firstLevel").hide();
  $(".reserve").show();
  $("#mapContainer").hide();
  reserveName=name;
  App.reserveChange(reserveName);
  App.flyToExtent(3,reserveName);
  App.loadLineChar("2",reserveName);
  //
  ajax({
  url:getRootPath()+"gis/national/getNationalNatureDetail",
  data:{
  name:reserveName,
  year:$('#year').val(),
  },
  dataType:"json",
  type:"post",
  //async:false,
  success:function(data){
  if(data.status=="1001"){
  pathHtml=data.result.path;
  reportHtml=data.result.reportPath;
  //$(".right-top").append("<div class='dowWyBg'><img  src='img/wy_mr.png' class='wy' /><img  src='img/bg_mr.png' class='bg'/></div>");
  $(".wy").hover(function(){
  $(this).attr("src","img/wy_xz.png");
  },function(){
  $(this).attr("src","img/wy_mr.png");
  });
  $(".bg").hover(function(){
  $(this).attr("src","img/bg_xz.png");
  },function(){
  $(this).attr("src","img/bg_mr.png");
  });
  $(".wy").on("click",function(){
  if(!pathHtml){
  layer.msg("暂无详情介绍 !", {icon: 5});
  return;
  }
  window.open(pathHtml);
  });
  $(".bg").on("click",function(){
  if(reportHtml){
  var pdf="<object data='"+reportHtml+"' type='application/pdf' width='100%' height='100%'><iframe src='"+reportHtml+"' width='100%' height='100%' style='border: none;'></iframe></object>"
  layer.open({
  /*type: 1,
  area: ['80%', '90%'],
  title: '自然保护区报告预览',
  content: pdf,
  success: function() {
  //	var myPDF = new PDFObject({ url: getHost()+data.result}).embed('pdf');
  }*/
  title: '自然保护区报告预览',
  btnAlign: 'c',
  area: ['80%', '90%'],
  shade: 0.5,
  content: pdf,
  scrollbar: false,
  yes: function(index, layero) {
  layer.close(index);
  },
  cancel: function(index, layero) {
  layer.close(index);
  }
  });

  }else{
  layer.msg("暂无报告 !", {icon: 5});
  }


  });
  }
  },error:function(error){
  console.log(error);
  }
  })
  },
  //加载对比的影像
  loadCompareImage:function(name){
  //备注：2017年之前的影像为整年一次，2017年之后的影像分上下半年
  var selectedYear=$('#year').val();
  var forwardYear="";
  if(selectedYear=="201701"){
  forwardYear="2016";
  }else if(selectedYear<2017){
  forwardYear=parseInt(selectedYear)-1;
  }else if(selectedYear.substr(4,2)=="01"){
  forwardYear=parseInt(selectedYear.substr(0,4))-1+"02";
  }else if(selectedYear.substr(4,2)=="02"){
  forwardYear=selectedYear.substr(0,4)+"01";
  }
  //动态加载左右两侧影像数据
  var condition='[{"key": "NAME", "value": "'+name+'"}]';
  $.ajax({
  url:getRootPath() + 'db/data/getDataList',
  data:{
  menuId : 16, //menuId
  year : forwardYear,
  condition : condition,
  type : 0
  },
  type:"post",
  dataType:"json",
  success:function(data){
  var pathString="";
  if(data.result.length>0){
  data.result.forEach(function(item,v){
  //因数据名称带有"_"，需先删除，最后再添加
  var path1=item.TRUE_PATH.replace(item.FILE,"");
  var path2=path1.replace(Config.pathString,"");
  //反斜杠换位"_"连接
  var truePath=path2.replace(/\\/g,'_');
  //将最后一个_替换为"/"
  var pathEnd=truePath.replaceCharAt(truePath.lastIndexOf("_"),"/");
  pathString+=pathEnd+item.FILE;
  pathString+=",";
  });
  //删除原有服务
  if(App.leftMap.getLayer("dynamic")){
  App.leftMap.removeLayer(App.leftMap.getLayer("dynamic"));
  }
  //生成随机地图服务名称
  $.ajax({
  url:Config.DynamicIP+"arcgis/rest/services/tmp/autoname/dynpubserver",
  data:{
  op:"create",
  listlyr:pathString.substring(0, pathString.length-1)
  },
  type:"post",
  dataType:"json",
  success:function(data){
  if(data["return"]=="success"){
  var dynamicLayer=new esri.layers.ArcGISDynamicMapServiceLayer(Config.DynamicIP + data.url.substring(data.url.indexOf("arcgis")),{
  visible:true,
  id:"dynamic"
  });
  App.leftMap.addLayer(dynamicLayer,2);
  }
  }
  });
  }
  }
  });
  var condition='[{"key": "NAME", "value": "'+name+'"}]';
  $.ajax({
  url:getRootPath() + 'db/data/getDataList',
  data:{
  menuId : 16, //menuId
  year : selectedYear,
  condition : condition,
  type : 0
  },
  type:"post",
  dataType:"json",
  success:function(data){
  var pathString="";
  if(data.result.length>0){
  data.result.forEach(function(item,v){
  //因数据名称带有"_"，需先删除，最后再添加
  var path1=item.TRUE_PATH.replace(item.FILE,"");
  var path2=path1.replace(Config.pathString,"");
  //反斜杠换位"_"连接
  var truePath=path2.replace(/\\/g,'_');
  //将最后一个_替换为"/"
  var pathEnd=truePath.replaceCharAt(truePath.lastIndexOf("_"),"/");
  pathString+=pathEnd+item.FILE;
  pathString+=",";
  });
  //删除原有服务
  if(App.rightMap.getLayer("dynamic")){
  App.rightMap.removeLayer(App.rightMap.getLayer("dynamic"));
  }
  //生成随机地图服务名称
  $.ajax({
  url:Config.DynamicIP+"arcgis/rest/services/tmp/autoname/dynpubserver",
  data:{
  op:"create",
  listlyr:pathString.substring(0, pathString.length-1)
  },
  type:"post",
  dataType:"json",
  success:function(data){
  if(data["return"]=="success"){
  var dynamicLayer=new esri.layers.ArcGISDynamicMapServiceLayer(Config.DynamicIP + data.url.substring(data.url.indexOf("arcgis")),{
  visible:true,
  id:"dynamic"
  });
  App.rightMap.addLayer(dynamicLayer,2);
  }
  }
  });
  }
  }
  });
  },
  //获取结果数据最大值
  getMaxValue : function(data, key) {
  var max = 0;
  data.forEach(function(item) {
  if (max <= item[key]) {
  max = item[key];
  }
  });
  return max;
  },
  //加载下面折线图
  loadLineChar:function(level,districtName){
  var countType = $("input[name='type']:checked").val();
  var resultType=$(".tabs .active").data("type");
  if(reserveLevel){
  $(".pp").hide();
  level="3";
  districtName=reserveName;
  if(countType!="2"||countType!="4"){
  $("input[name='type']").removeAttr('checked');
  $("input[name='type'][title='人类活动变化']").attr('checked',true);
  checkform.render('radio');
  countType = $("input[name='type']:checked").val();
  }
  }else{
  $(".pp").show();
  }
  if(level==4){
  level=0
  }
  $.ajax({
  url: getRootPath() + 'gis/human/activity/getTimeAxisCount',
  dataType: 'json',
  data:{
  level:level,
  district:districtName,
  resultType:resultType,
  countType:countType
  },
  type: 'post',
  async: true,
  success: function(data) {
  //统计 信息
  if(data.status=='1001'){
  var series=[];
  var xname="单位(个)";
  if(resultType=='A'){
  xname="单位(km2)";
  }else if(resultType=='R'){
  xname="单位(%)";
  }
  data.result.countList.forEach(function(item){
  var obj={name:item.name,data:item.value,type:'line'}
  if(countType=="1"){
  obj={name:item.name,data:item.value,type:'line',itemStyle: {normal: {areaStyle: {color : 'rgba(9, 143, 255, 0.5)'},lineStyle:{ color:'rgb(9, 143,255)' }}}}
  }
  series.push(obj)
  });
  statistic.loadLine(series,data.result.years,xname);
  }
  },
  error: function(err) {
  console.log(err);
  }
  });
  },
  //根据所选地图等级进行地图服务筛选
  getVisibileMapServer : function() {
  if (App.level == 0) {
  App.InspectorLayer.setVisibility(true);
  App.provinceLayer.setVisibility(false);
  App.boundaryLayer.setVisibility(false);
  App.activeLayer.setVisibility(false);
  } else if (App.level == 1) {
  App.InspectorLayer.setVisibility(false);
  App.provinceLayer.setVisibility(true);
  App.boundaryLayer.setVisibility(false);
  App.activeLayer.setVisibility(false);
  // 根据点击的大区对省级进行筛选，测试暂时省级服务为对应大区字段
  App.provinceLayer.setDefinitionExpression("ZONE='" + App.districtName + "'");
  } else if (App.level == 2) {
  App.InspectorLayer.setVisibility(false);
  App.provinceLayer.setVisibility(true);
  // 根据点击的省份对省级进行筛选，测试暂时省级服务
  App.provinceLayer.setDefinitionExpression("DISTRICTNA='" + App.districtName + "'");

  App.activeLayer.setDefinitionExpression("省份 like '" + (App.districtName.slice(0, 2)) + "%'");
  App.boundaryLayer.setDefinitionExpression("省份 like '" + (App.districtName.slice(0, 2)) + "%'");
  App.boundaryLayer.setVisibility(true);
  App.activeLayer.setVisibility(true);


  //App.boundaryLayer.refresh();
  }else if (App.level == 4) {
  App.provinceLayer.setDefinitionExpression("");
  App.InspectorLayer.setVisibility(false);
  App.provinceLayer.setVisibility(true);
  //App.boundaryLayer.refresh();
  }
  },
  flyToExtents:function(x,y,map){
  App.point.x=x;
  App.point.y=y;
  map.centerAndZoom(App.point,14);
  },
  //根据选择的区划移动到
  flyToExtent : function(level, name) {
  var layer;
  var outFields;
  level=parseInt(level);
  if (level == 0) {
  var extent = new esri.geometry.Extent(Config.fullMapExtent,
  new esri.SpatialReference({
  wkid : "102100"
  }));
  App.map.setExtent(extent);
  return;
  } else if (level == 1) {
  layer = Config.layerUrl_Inspector + "/0";
  outFields = [ "DISTRICTNA", "ZONE" ];
  } else if (level == 2) {
  layer = Config.administrativeArea_SS + "/0";
  outFields = [ "DISTRICTNA", "ZONE" ];
  }else if(level == 3) {
  layer =Config["countryZone"+$("#year").val()] + "/0";
  outFields = [ "标准名称"];
  }
  require([ "dojo/dom", "esri/tasks/query", "esri/tasks/QueryTask" ],
  function(dom, Query, QueryTask) {
  var queryTask = new QueryTask(layer);
  var query = new Query();
  query.multipatchOption = "xyFootprint";
  query.outFields = outFields;
  query.spatialReference = new esri.SpatialReference({wkid:102100});
  query.outSpatialReference =new esri.SpatialReference({wkid:102100});
  if(level!=3){
  query.where = "DISTRICTNA='" + name + "'";
  }else{
  query.where = "标准名称 like'%" + name + "%'";
  }

  query.returnGeometry = true;
  queryTask.on("error", function(e) {
  console.log(e);
  });
  queryTask.execute(query, function(result) {
  if (result.features.length > 0) {
  if(level != 3){
  App.map.setExtent(result.features[0].geometry.getExtent());
  }else{
  var extent=result.features[0].geometry.getExtent();
  App.leftMap.setExtent(extent);
  for(var i=0;i<result.features.length;i++){
  var graphic1=result.features[i];
  graphic1.setSymbol(App.symbolFill4);
  App.graphicRightLayer.add(graphic1);
  //同一个graphic不能同时添加在两个map里
  var graphic=new esri.Graphic(result.features[i].geometry);
  graphic.setSymbol(App.symbolFill4);
  App.graphicLeftLayer.add(graphic);

  }

  }
  }
  });
  });
  },
  //省份督察区切换
  changeArea:function(){
  App.flyToExtent(0);
  App.districtName='全国';
  if($("#area").attr("title")!="全国省份"){
  isSupervision=true;
  App.level=0;
  App.activeChange(App.level);
  App.getVisibileMapServer();
  }else{
  isSupervision=false;
  App.level=4;
  App.activeChange(App.level);
  App.getVisibileMapServer();
  }
  }
  };

  //页面操作
  //页面操作
  if(districtName == "null" || districtName == null){
  $(".select_input").on("click",App.getDivision);
  }
  $('#detail').on('click', function() {
  layer.open({
  type : 1,
  title : [ '详情' ],
  content : $('#layer'),
  area : [ '540px', '360px' ],
  btn : '确定',
  btnAlign : 'c',
  resize : false,
  });
  });
  $("#countNum").on("click", function() {
  $("#numberLayer").css("display", "block");
  $("#areaLayer").css("display", "none");
  $('#areaNum').css("background-color", "white");
  $('#countNum').css("background-color", "#D9E9F2");
  });
  $("#areaNum").on("click", function() {
  $("#areaLayer").css("display", "block");
  $("#numberLayer").css("display", "none");
  $('#countNum').css("background-color", "white");
  $('#areaNum').css("background-color", "#D9E9F2");
  });
  //核心区，缓冲器，实验区切换
  $(".nextTabCon").on("click",function(){
  $(this).addClass("active").siblings().removeClass("active");
  switch($(this).data("id")){
  case "all":
  peace = "";
  break;
  case "coreZone":
  peace = "核心区";
  break;
  case "buffer":
  peace = "缓冲区";
  break;
  case "laboratoryArea":
  peace = "实验区";
  break;
  }
  if($(".reserve").is(':visible')){
  App.reserveChange(reserveName);
  }else{
  App.activeChange(App.level);
  }

  });

  /*右侧缩放*/
  $('#adjustable').on('click', function() {
  var right = $('#rightDetail').css("right").split("px")[0];
  if (right == 0) {
  $('#rightDetail').animate({
  right : "-379px"
  });
  $('#leftMap').animate({
  right : "21px"
  });
  } else {
  $('#rightDetail').animate({
  right : 0
  });
  $('#leftMap').animate({
  right : "400px"
  });
  }
  });